# MindLab quick daily stack
# - MUST be run from: C:\Projects\MindLab_Starter_Project
# - Runs (in order):
#     0) Cleanup old processes on ports 8085 (backend) and 5177 (frontend dev)
$runAll = Join-Path (Split-Path -Parent $PSCommandPath) "run_all.ps1"
if (Test-Path $runAll) {
    Write-Host "[INFO] Optional: running PROD sanity via run_all.ps1 ..." -ForegroundColor Cyan

    # Temporarily suppress hard errors from the legacy script
    $prevEAP = $ErrorActionPreference
    $ErrorActionPreference = "SilentlyContinue"

    try {
        # Run the legacy script, hide its own error output
        & $runAll 2>$null | Out-Null

        if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne $null) {
            Write-Host "[WARN] run_all.ps1 exited with code $LASTEXITCODE (ignoring for quick daily stack)." -ForegroundColor Yellow
        }
        else {
            Write-Host "[OK] run_all.ps1 completed (optional PROD sanity)." -ForegroundColor Green
        }
    }
    catch {
        Write-Host ("[WARN] Optional run_all.ps1 step failed: " + # MindLab quick daily stack
# - MUST be run from: C:\Projects\MindLab_Starter_Project
# - Runs (in order):
#     0) Cleanup old processes on ports 8085 (backend) and 5177 (frontend dev)
#     1) run_all.ps1              (quick PROD sanity)
#     2) mindlab_daily_start.ps1
#     3) mindlab_daily_routine.ps1 -TraceOn

$ErrorActionPreference = "Stop"

function Ensure-AtProjectRoot {
    param(
        [string]$ExpectedRoot = "C:\Projects\MindLab_Starter_Project"
    )
    $current = (Get-Location).ProviderPath
    if ($current -ne $ExpectedRoot) {
        Write-Host "[INFO] Changing location to $ExpectedRoot" -ForegroundColor Cyan
        Set-Location $ExpectedRoot
    }
    Write-Host "[INFO] Current location: $(Get-Location)" -ForegroundColor Green
}

function Stop-PortProcess {
    param(
        [int]$Port
    )

    Write-Host "`n[INFO] Checking for process using port $Port ..." -ForegroundColor Cyan

    try {
        $connections = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue |
                       Where-Object { $_.State -eq "Listen" -or $_.State -eq "Established" } |
                       Select-Object -Property OwningProcess -Unique

        if (-not $connections) {
            Write-Host "[INFO] No process currently using port $Port." -ForegroundColor Green
            return
        }

        foreach ($conn in $connections) {
            $pid = $conn.OwningProcess
            try {
                $proc = Get-Process -Id $pid -ErrorAction Stop
                Write-Host "[INFO] Stopping process PID $pid ($($proc.ProcessName)) on port $Port ..." -ForegroundColor Yellow
                Stop-Process -Id $pid -Force -ErrorAction Stop
                Write-Host "[OK] Stopped PID $pid." -ForegroundColor Green
            }
            catch {
                Write-Host "[WARN] Failed to stop PID $pid on port $Port." -ForegroundColor Yellow
            }
        }
    }
    catch {
        Write-Host "[WARN] Could not inspect port $Port. Port cleanup skipped." -ForegroundColor Yellow
    }
}

Write-Host "=== MindLab quick daily stack ===" -ForegroundColor Cyan

# STEP 0: Clean up any leftover backend/frontend processes
Ensure-AtProjectRoot
Stop-PortProcess -Port 8085    # backend
Stop-PortProcess -Port 5177    # frontend dev

# STEP 1: Quick PROD sanity (includes Playwright)
Ensure-AtProjectRoot
Write-Host "`n[STEP 1] Running quick PROD sanity (run_all.ps1)..." -ForegroundColor Cyan
.\run_all.ps1

# STEP 2: MindLab daily start
Ensure-AtProjectRoot
Write-Host "`n[STEP 2] Running daily start (mindlab_daily_start.ps1)..." -ForegroundColor Cyan
.\mindlab_daily_start.ps1

# STEP 3: MindLab daily routine (status + /daily flows)
Ensure-AtProjectRoot
Write-Host "`n[STEP 3] Running daily routine (mindlab_daily_routine.ps1 -TraceOn)..." -ForegroundColor Cyan
.\mindlab_daily_routine.ps1 -TraceOn

Write-Host "`n[RESULT] run_quick_daily_stack.ps1 completed." -ForegroundColor Green
.Exception.Message) -ForegroundColor Yellow
    }
    finally {
        $ErrorActionPreference = $prevEAP
    }
}
else {
    Write-Host "[INFO] Optional run_all.ps1 script not found; skipping PROD sanity helper." -ForegroundColor Yellow
}
#     2) mindlab_daily_start.ps1
#     3) mindlab_daily_routine.ps1 -TraceOn

$ErrorActionPreference = "Stop"

function Ensure-AtProjectRoot {
    param(
        [string]$ExpectedRoot = "C:\Projects\MindLab_Starter_Project"
    )
    $current = (Get-Location).ProviderPath
    if ($current -ne $ExpectedRoot) {
        Write-Host "[INFO] Changing location to $ExpectedRoot" -ForegroundColor Cyan
        Set-Location $ExpectedRoot
    }
    Write-Host "[INFO] Current location: $(Get-Location)" -ForegroundColor Green
}

function Stop-PortProcess {
    param(
        [int]$Port
    )

    Write-Host "`n[INFO] Checking for process using port $Port ..." -ForegroundColor Cyan

    try {
        $connections = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue |
                       Where-Object { $_.State -eq "Listen" -or $_.State -eq "Established" } |
                       Select-Object -Property OwningProcess -Unique

        if (-not $connections) {
            Write-Host "[INFO] No process currently using port $Port." -ForegroundColor Green
            return
        }

        foreach ($conn in $connections) {
            $pid = $conn.OwningProcess
            try {
                $proc = Get-Process -Id $pid -ErrorAction Stop
                Write-Host "[INFO] Stopping process PID $pid ($($proc.ProcessName)) on port $Port ..." -ForegroundColor Yellow
                Stop-Process -Id $pid -Force -ErrorAction Stop
                Write-Host "[OK] Stopped PID $pid." -ForegroundColor Green
            }
            catch {
                Write-Host "[WARN] Failed to stop PID $pid on port $Port." -ForegroundColor Yellow
            }
        }
    }
    catch {
        Write-Host "[WARN] Could not inspect port $Port. Port cleanup skipped." -ForegroundColor Yellow
    }
}

Write-Host "=== MindLab quick daily stack ===" -ForegroundColor Cyan

# STEP 0: Clean up any leftover backend/frontend processes
Ensure-AtProjectRoot
Stop-PortProcess -Port 8085    # backend
Stop-PortProcess -Port 5177    # frontend dev

# STEP 1: Quick PROD sanity (includes Playwright)
Ensure-AtProjectRoot
$runAll = Join-Path (Split-Path -Parent $PSCommandPath) "run_all.ps1"
if (Test-Path $runAll) {
    Write-Host "[INFO] Optional: running PROD sanity via run_all.ps1 ..." -ForegroundColor Cyan

    # Temporarily suppress hard errors from the legacy script
    $prevEAP = $ErrorActionPreference
    $ErrorActionPreference = "SilentlyContinue"

    try {
        # Run the legacy script, hide its own error output
        & $runAll 2>$null | Out-Null

        if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne $null) {
            Write-Host "[WARN] run_all.ps1 exited with code $LASTEXITCODE (ignoring for quick daily stack)." -ForegroundColor Yellow
        }
        else {
            Write-Host "[OK] run_all.ps1 completed (optional PROD sanity)." -ForegroundColor Green
        }
    }
    catch {
        Write-Host ("[WARN] Optional run_all.ps1 step failed: " + # MindLab quick daily stack
# - MUST be run from: C:\Projects\MindLab_Starter_Project
# - Runs (in order):
#     0) Cleanup old processes on ports 8085 (backend) and 5177 (frontend dev)
#     1) run_all.ps1              (quick PROD sanity)
#     2) mindlab_daily_start.ps1
#     3) mindlab_daily_routine.ps1 -TraceOn

$ErrorActionPreference = "Stop"

function Ensure-AtProjectRoot {
    param(
        [string]$ExpectedRoot = "C:\Projects\MindLab_Starter_Project"
    )
    $current = (Get-Location).ProviderPath
    if ($current -ne $ExpectedRoot) {
        Write-Host "[INFO] Changing location to $ExpectedRoot" -ForegroundColor Cyan
        Set-Location $ExpectedRoot
    }
    Write-Host "[INFO] Current location: $(Get-Location)" -ForegroundColor Green
}

function Stop-PortProcess {
    param(
        [int]$Port
    )

    Write-Host "`n[INFO] Checking for process using port $Port ..." -ForegroundColor Cyan

    try {
        $connections = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue |
                       Where-Object { $_.State -eq "Listen" -or $_.State -eq "Established" } |
                       Select-Object -Property OwningProcess -Unique

        if (-not $connections) {
            Write-Host "[INFO] No process currently using port $Port." -ForegroundColor Green
            return
        }

        foreach ($conn in $connections) {
            $pid = $conn.OwningProcess
            try {
                $proc = Get-Process -Id $pid -ErrorAction Stop
                Write-Host "[INFO] Stopping process PID $pid ($($proc.ProcessName)) on port $Port ..." -ForegroundColor Yellow
                Stop-Process -Id $pid -Force -ErrorAction Stop
                Write-Host "[OK] Stopped PID $pid." -ForegroundColor Green
            }
            catch {
                Write-Host "[WARN] Failed to stop PID $pid on port $Port." -ForegroundColor Yellow
            }
        }
    }
    catch {
        Write-Host "[WARN] Could not inspect port $Port. Port cleanup skipped." -ForegroundColor Yellow
    }
}

Write-Host "=== MindLab quick daily stack ===" -ForegroundColor Cyan

# STEP 0: Clean up any leftover backend/frontend processes
Ensure-AtProjectRoot
Stop-PortProcess -Port 8085    # backend
Stop-PortProcess -Port 5177    # frontend dev

# STEP 1: Quick PROD sanity (includes Playwright)
Ensure-AtProjectRoot
Write-Host "`n[STEP 1] Running quick PROD sanity (run_all.ps1)..." -ForegroundColor Cyan
.\run_all.ps1

# STEP 2: MindLab daily start
Ensure-AtProjectRoot
Write-Host "`n[STEP 2] Running daily start (mindlab_daily_start.ps1)..." -ForegroundColor Cyan
.\mindlab_daily_start.ps1

# STEP 3: MindLab daily routine (status + /daily flows)
Ensure-AtProjectRoot
Write-Host "`n[STEP 3] Running daily routine (mindlab_daily_routine.ps1 -TraceOn)..." -ForegroundColor Cyan
.\mindlab_daily_routine.ps1 -TraceOn

Write-Host "`n[RESULT] run_quick_daily_stack.ps1 completed." -ForegroundColor Green
.Exception.Message) -ForegroundColor Yellow
    }
    finally {
        $ErrorActionPreference = $prevEAP
    }
}
else {
    Write-Host "[INFO] Optional run_all.ps1 script not found; skipping PROD sanity helper." -ForegroundColor Yellow
}
$runAll = Join-Path (Split-Path -Parent $PSCommandPath) "run_all.ps1"
if (Test-Path $runAll) {
    Write-Host "[INFO] Optional: running PROD sanity via run_all.ps1 ..." -ForegroundColor Cyan

    # Temporarily suppress hard errors from the legacy script
    $prevEAP = $ErrorActionPreference
    $ErrorActionPreference = "SilentlyContinue"

    try {
        # Run the legacy script, hide its own error output
        & $runAll 2>$null | Out-Null

        if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne $null) {
            Write-Host "[WARN] run_all.ps1 exited with code $LASTEXITCODE (ignoring for quick daily stack)." -ForegroundColor Yellow
        }
        else {
            Write-Host "[OK] run_all.ps1 completed (optional PROD sanity)." -ForegroundColor Green
        }
    }
    catch {
        Write-Host ("[WARN] Optional run_all.ps1 step failed: " + # MindLab quick daily stack
# - MUST be run from: C:\Projects\MindLab_Starter_Project
# - Runs (in order):
#     0) Cleanup old processes on ports 8085 (backend) and 5177 (frontend dev)
#     1) run_all.ps1              (quick PROD sanity)
#     2) mindlab_daily_start.ps1
#     3) mindlab_daily_routine.ps1 -TraceOn

$ErrorActionPreference = "Stop"

function Ensure-AtProjectRoot {
    param(
        [string]$ExpectedRoot = "C:\Projects\MindLab_Starter_Project"
    )
    $current = (Get-Location).ProviderPath
    if ($current -ne $ExpectedRoot) {
        Write-Host "[INFO] Changing location to $ExpectedRoot" -ForegroundColor Cyan
        Set-Location $ExpectedRoot
    }
    Write-Host "[INFO] Current location: $(Get-Location)" -ForegroundColor Green
}

function Stop-PortProcess {
    param(
        [int]$Port
    )

    Write-Host "`n[INFO] Checking for process using port $Port ..." -ForegroundColor Cyan

    try {
        $connections = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue |
                       Where-Object { $_.State -eq "Listen" -or $_.State -eq "Established" } |
                       Select-Object -Property OwningProcess -Unique

        if (-not $connections) {
            Write-Host "[INFO] No process currently using port $Port." -ForegroundColor Green
            return
        }

        foreach ($conn in $connections) {
            $pid = $conn.OwningProcess
            try {
                $proc = Get-Process -Id $pid -ErrorAction Stop
                Write-Host "[INFO] Stopping process PID $pid ($($proc.ProcessName)) on port $Port ..." -ForegroundColor Yellow
                Stop-Process -Id $pid -Force -ErrorAction Stop
                Write-Host "[OK] Stopped PID $pid." -ForegroundColor Green
            }
            catch {
                Write-Host "[WARN] Failed to stop PID $pid on port $Port." -ForegroundColor Yellow
            }
        }
    }
    catch {
        Write-Host "[WARN] Could not inspect port $Port. Port cleanup skipped." -ForegroundColor Yellow
    }
}

Write-Host "=== MindLab quick daily stack ===" -ForegroundColor Cyan

# STEP 0: Clean up any leftover backend/frontend processes
Ensure-AtProjectRoot
Stop-PortProcess -Port 8085    # backend
Stop-PortProcess -Port 5177    # frontend dev

# STEP 1: Quick PROD sanity (includes Playwright)
Ensure-AtProjectRoot
Write-Host "`n[STEP 1] Running quick PROD sanity (run_all.ps1)..." -ForegroundColor Cyan
.\run_all.ps1

# STEP 2: MindLab daily start
Ensure-AtProjectRoot
Write-Host "`n[STEP 2] Running daily start (mindlab_daily_start.ps1)..." -ForegroundColor Cyan
.\mindlab_daily_start.ps1

# STEP 3: MindLab daily routine (status + /daily flows)
Ensure-AtProjectRoot
Write-Host "`n[STEP 3] Running daily routine (mindlab_daily_routine.ps1 -TraceOn)..." -ForegroundColor Cyan
.\mindlab_daily_routine.ps1 -TraceOn

Write-Host "`n[RESULT] run_quick_daily_stack.ps1 completed." -ForegroundColor Green
.Exception.Message) -ForegroundColor Yellow
    }
    finally {
        $ErrorActionPreference = $prevEAP
    }
}
else {
    Write-Host "[INFO] Optional run_all.ps1 script not found; skipping PROD sanity helper." -ForegroundColor Yellow
}

# STEP 2: MindLab daily start
Ensure-AtProjectRoot
Write-Host "`n[STEP 2] Running daily start (mindlab_daily_start.ps1)..." -ForegroundColor Cyan
.\mindlab_daily_start.ps1

# STEP 3: MindLab daily routine (status + /daily flows)
Ensure-AtProjectRoot
Write-Host "`n[STEP 3] Running daily routine (mindlab_daily_routine.ps1 -TraceOn)..." -ForegroundColor Cyan
.\mindlab_daily_routine.ps1 -TraceOn

Write-Host "`n[RESULT] run_quick_daily_stack.ps1 completed." -ForegroundColor Green

