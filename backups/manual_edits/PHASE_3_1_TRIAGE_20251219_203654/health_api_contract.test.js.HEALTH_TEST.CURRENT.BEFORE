const http = require('http');
const fetch = require('node-fetch');

function startServer(app) {
  return new Promise((resolve, reject) => {
    const server = http.createServer(app);
    server.listen(0, '127.0.0.1', () => {
      const addr = server.address();
      const baseUrl = `http://127.0.0.1:${addr.port}`;
      resolve({ server, baseUrl });
    });
    server.on('error', reject);
  });
}

async function getJson(url) {
  const r = await fetch(url);
  if (!r.ok) {
    throw new Error(`GET failed: ${r.status}`);
  }
  return r.json();
}

describe('Health API contract', () => {
  let server, baseUrl, app;

  beforeAll(async () => {
    ({ app } = require('../../src/server.cjs'));
    ({ server, baseUrl } = await startServer(app));
  });

  afterAll(() => {
    server.close();
  });

  test('GET /health returns { status: "ok" }', async () => {
    const json = await getJson(`${baseUrl}/health`);
    expect(json).toEqual({ status: 'ok' });
  });
});
