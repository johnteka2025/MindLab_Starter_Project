const BACKEND = process.env.MINDLAB_BACKEND_URL || "http://localhost:8085";

async function jget(path) {
  const r = await fetch(${BACKEND});
  if (!r.ok) throw new Error(GET  failed: );
  return r.json().catch(() => ({}));
}

async function jpost(path, body) {
  const r = await fetch(${BACKEND}, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });
  if (!r.ok) throw new Error(POST  failed: );
  return r.json().catch(() => ({}));
}

test("contract: /health, /progress, /progress/solve behave (backend must be running)", async () => {
  const h = await fetch(${BACKEND}/health);
  expect(h.ok).toBe(true);

  const before = await jget("/progress");
  expect(typeof before.total).toBe("number");
  expect(typeof before.solved).toBe("number");
  expect(before.solved).toBeGreaterThanOrEqual(0);
  expect(before.total).toBeGreaterThanOrEqual(0);
  expect(before.solved).toBeLessThanOrEqual(before.total);

  await jpost("/progress/solve", { puzzleId: 1 });

  const after = await jget("/progress");
  expect(after.solved).toBeGreaterThanOrEqual(before.solved);
  expect(after.solved).toBeLessThanOrEqual(after.total);
}, 15000);
