Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

try {
  $root = (Resolve-Path ".").Path
  Write-Host "=== PHASE 5C v2 â€” Fix puzzles/index.json encoding to UTF-8 ===" -ForegroundColor Cyan
  Write-Host "Project root: $root" -ForegroundColor Gray

  # Phase 4 freeze guard (do not modify anything inside)
  $freeze = Join-Path $root "ARCHIVE_PHASE_4"
  if (-not (Test-Path $freeze)) { throw "Phase 4 freeze folder missing: $freeze" }

  # Target
  $target = Join-Path $root "backend\src\puzzles\index.json"
  if (-not (Test-Path $target)) { throw "Missing target file: $target" }

  # Logs
  $logDir = Join-Path $root "phase5_logs"
  if (-not (Test-Path $logDir)) { New-Item -ItemType Directory -Force $logDir | Out-Null }

  $ts = Get-Date -Format "yyyyMMdd_HHmmss"
  $backup = Join-Path $logDir ("index.json.bak_phase5c_{0}" -f $ts)
  Copy-Item -Force $target $backup
  Write-Host "Backup: $backup" -ForegroundColor DarkGray

  # Read as text (auto-detect), then write as UTF-8 without BOM
  $text = [System.IO.File]::ReadAllText($target)
  $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  [System.IO.File]::WriteAllText($target, $text, $utf8NoBom)
  Write-Host "Rewrote as UTF-8 (no BOM): $target" -ForegroundColor Green

  # Create a temporary JS sanity checker (avoids PowerShell quote escaping issues)
  $checker = Join-Path $logDir ("phase5c_check_{0}.js" -f $ts)
  $checkerCode = @"
const fs = require("fs");
const p = process.argv[2];
const raw = fs.readFileSync(p, "utf8");
JSON.parse(raw);
console.log("NODE_JSON_PARSE_OK");
"@
  [System.IO.File]::WriteAllText($checker, $checkerCode, $utf8NoBom)
  Write-Host "Checker: $checker" -ForegroundColor DarkGray

  # Sanity 1: Node parse (matches backend behavior)
  $nodeOut = & node $checker $target 2>&1
  if ($LASTEXITCODE -ne 0 -or ($nodeOut -notmatch "NODE_JSON_PARSE_OK")) {
    throw "Node parse failed. Output:`n$nodeOut"
  }
  Write-Host "Sanity: NODE_JSON_PARSE_OK" -ForegroundColor Green

  # Sanity 2: /puzzles (backend must be running)
  try {
    $r = Invoke-WebRequest "http://localhost:8085/puzzles" -UseBasicParsing -TimeoutSec 10
    Write-Host ("Sanity: GET /puzzles => {0}" -f $r.StatusCode) -ForegroundColor Green
  } catch {
    Write-Host "Sanity NOTE: GET /puzzles failed (backend may be down)." -ForegroundColor Yellow
    Write-Host ("Details: {0}" -f $_.Exception.Message) -ForegroundColor DarkYellow
  }

  Write-Host ("Returned to project root: {0}" -f $root) -ForegroundColor DarkGray
}
catch {
  Write-Host ("PHASE_5C v2 ERROR: {0}" -f $_.Exception.Message) -ForegroundColor Red
  throw
}
finally {
  Set-Location (Resolve-Path ".").Path | Out-Null
}
