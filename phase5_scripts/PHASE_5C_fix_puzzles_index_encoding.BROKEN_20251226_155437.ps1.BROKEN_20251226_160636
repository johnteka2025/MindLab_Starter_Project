Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

try {
  $root = (Resolve-Path ".").Path
  Write-Host "=== PHASE 5C â€” Fix puzzles/index.json encoding (UTF-8) ===" -ForegroundColor Cyan
  Write-Host "Project root: $root" -ForegroundColor Gray

  # Golden Rule: Phase 4 is frozen (do not touch)
  $freeze = Join-Path $root "ARCHIVE_PHASE_4"
  if (-not (Test-Path $freeze)) { throw "Phase 4 freeze folder missing: $freeze" }

  # Target file (LIVE)
  $target = Join-Path $root "backend\src\puzzles\index.json"
  if (-not (Test-Path $target)) { throw "Missing target file: $target" }

  # Ensure logs folder
  $logDir = Join-Path $root "phase5_logs"
  if (-not (Test-Path $logDir)) { New-Item -ItemType Directory -Force $logDir | Out-Null }

  $ts = Get-Date -Format "yyyyMMdd_HHmmss"
  $backup = Join-Path $logDir ("index.json.bak_phase5c_{0}" -f $ts)
  Copy-Item -Force $target $backup
  Write-Host "Backup created: $backup" -ForegroundColor DarkGray

  # Read bytes and detect encoding (basic)
  $bytes = [System.IO.File]::ReadAllBytes($target)
  $isUtf16LE = ($bytes.Length -ge 2 -and $bytes[0] -eq 0xFF -and $bytes[1] -eq 0xFE)
  $isUtf16BE = ($bytes.Length -ge 2 -and $bytes[0] -eq 0xFE -and $bytes[1] -eq 0xFF)

  if ($isUtf16LE -or $isUtf16BE) {
    Write-Host "Detected UTF-16 BOM. Converting to UTF-8..." -ForegroundColor Yellow
  } else {
    Write-Host "No UTF-16 BOM detected. Rewriting as UTF-8 anyway (safe)..." -ForegroundColor Yellow
  }

  # Read as text using .NET auto-detect, then write UTF-8 (no BOM if possible)
  $text = [System.IO.File]::ReadAllText($target)

  # Write UTF-8 without BOM using .NET
  $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
  [System.IO.File]::WriteAllText($target, $text, $utf8NoBom)

  Write-Host "PHASE_5C GREEN: Rewrote file as UTF-8 (no BOM): $target" -ForegroundColor Green

  # Sanity 1: Node JSON.parse directly from file (this matches backend behavior)
  $nodeCmd = "node -e ""const fs=require('fs'); const p=process.argv[1]; const raw=fs.readFileSync(p,'utf8'); JSON.parse(raw); console.log('NODE_JSON_PARSE_OK');"" ""$target"""
  $nodeOut = cmd /c $nodeCmd 2>&1
  if ($LASTEXITCODE -ne 0 -or ($nodeOut -notmatch "NODE_JSON_PARSE_OK")) {
    throw "Node parse failed. Output:`n$nodeOut"
  }
  Write-Host "Sanity: NODE_JSON_PARSE_OK" -ForegroundColor Green

  # Sanity 2: Call server /puzzles (requires backend running)
  try {
    $r = Invoke-WebRequest "http://localhost:8085/puzzles" -UseBasicParsing -TimeoutSec 10
    Write-Host ("Sanity: GET /puzzles => {0}" -f $r.StatusCode) -ForegroundColor Green
  } catch {
    Write-Host "Sanity NOTE: GET /puzzles failed (backend might not be running yet)." -ForegroundColor Yellow
    Write-Host ("Details: {0}" -f $_.Exception.Message) -ForegroundColor DarkYellow
  }

  Write-Host ("Returned to project root: {0}" -f $root) -ForegroundColor DarkGray
}
catch {
  Write-Host ("PHASE_5C ERROR: {0}" -f $_.Exception.Message) -ForegroundColor Red
  throw
}
finally {
  Set-Location (Resolve-Path ".").Path | Out-Null
}
