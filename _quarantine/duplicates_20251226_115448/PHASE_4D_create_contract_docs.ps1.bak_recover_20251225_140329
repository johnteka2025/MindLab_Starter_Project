# PHASE_4D_create_contract_docs.ps1
# Creates Persistence / Data Contract documentation for Progress Persistence (Phase 4)

$ErrorActionPreference = "Stop"

function Assert-Path([string]$p, [string]$label) {
  if (-not (Test-Path $p)) { throw "Missing required ${label}: $p" }
}

try {
  $root = "C:\Projects\MindLab_Starter_Project"
  Set-Location $root

  $docsDir = Join-Path $root "docs"
  if (-not (Test-Path $docsDir)) { New-Item -ItemType Directory -Path $docsDir | Out-Null }

  $progressFile = Join-Path $root "backend\src\data\progress.json"
  $persistenceModule = Join-Path $root "backend\src\progressPersistence.cjs"

  Assert-Path $progressFile "progress.json"
  Assert-Path $persistenceModule "progressPersistence.cjs"

  $outDoc = Join-Path $docsDir "PHASE_4_PERSISTENCE_CONTRACTS.md"

  $lines = @()
  $lines += "# Phase 4 — Persistence Contracts"
  $lines += ""
  $lines += "## Data Contract — backend\src\data\progress.json"
  $lines += ""
  $lines += "**File path:** backend\src\data\progress.json  "
  $lines += "**Purpose:** Durable state for Daily Challenge progress (survives server restart)"
  $lines += ""
  $lines += "### Source of Truth (Golden Rule)"
  $lines += "- `solvedPuzzleIds` is the canonical persisted structure."
  $lines += "- `solvedIds` on disk MUST always be derived from the keys of `solvedPuzzleIds`."
  $lines += ""
  $lines += "### Expected JSON Shape"
  $lines += "```json"
  $lines += "{"
  $lines += '  "total": 3,'
  $lines += '  "solved": 1,'
  $lines += '  "solvedToday": 1,'
  $lines += '  "totalSolved": 1,'
  $lines += '  "streak": 0,'
  $lines += '  "solvedIds": ["demo-1"],'
  $lines += '  "solvedPuzzleIds": { "demo-1": true }'
  $lines += "}"
  $lines += "```"
  $lines += ""
  $lines += "### Invariants"
  $lines += "- `solved` equals the count of keys in `solvedPuzzleIds`."
  $lines += "- `solvedIds` equals `Object.keys(solvedPuzzleIds)`."
  $lines += "- On reset:"
  $lines += "  - `solvedPuzzleIds` becomes `{}`."
  $lines += "  - `solvedIds` becomes `[]`."
  $lines += "  - `solved` becomes `0`."
  $lines += ""
  $lines += "---"
  $lines += ""
  $lines += "## API Contract (Progress)"
  $lines += ""
  $lines += "### GET /progress"
  $lines += "Returns:"
  $lines += "```json"
  $lines += '{ "total": 3, "solved": 1, "solvedIds": ["demo-1"] }'
  $lines += "```"
  $lines += ""
  $lines += "### POST /progress/reset"
  $lines += "Returns:"
  $lines += "```json"
  $lines += '{ "ok": true, "total": 3, "solved": 0, "solvedIds": [] }'
  $lines += "```"
  $lines += ""
  $lines += "### POST /progress/solve"
  $lines += "Body:"
  $lines += "```json"
  $lines += '{ "puzzleId": "demo-1" }'
  $lines += "```"
  $lines += ""
  $lines += "Returns:"
  $lines += "```json"
  $lines += '{ "ok": true, "puzzleId": "demo-1", "progress": { "total": 3, "solved": 1, "solvedToday": 1, "totalSolved": 1, "streak": 0, "solvedIds": ["demo-1"] } }'
  $lines += "```"
  $lines += ""
  $lines += "---"
  $lines += ""
  $lines += "## Nodemon Contract (Avoid Restart Loop)"
  $lines += ""
  $lines += "If the server writes to `backend\src\data\progress.json`, nodemon must ignore it."
  $lines += ""
  $lines += "Expected nodemon.json (backend\nodemon.json):"
  $lines += "```json"
  $lines += "{"
  $lines += '  "watch": ["src"],'
  $lines += '  "ignore": ['
  $lines += '    "data/progress.json",'
  $lines += '    "src/data/progress.json"'
  $lines += "  ]"
  $lines += "}"
  $lines += "```"

  Set-Content -Path $outDoc -Value $lines -Encoding UTF8

  Write-Host "PHASE_4D GREEN: wrote $outDoc" -ForegroundColor Green
  Write-Host "Returned to project root: $root" -ForegroundColor Green
}
catch {
  Write-Host "PHASE_4D ERROR: $($_.Exception.Message)" -ForegroundColor Red
  throw
}
