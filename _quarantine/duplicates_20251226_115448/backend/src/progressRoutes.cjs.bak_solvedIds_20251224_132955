// C:\Projects\MindLab_Starter_Project\backend\src\progressRoutes.cjs
"use strict";

module.exports = function (app) {
  // Single source of truth stored on globalThis so all routes share it
  if (!globalThis.__mindlabProgress) {
    globalThis.__mindlabProgress = {
      total: 3,
      solved: 0,
      solvedToday: 0,
      totalSolved: 0,
      streak: 0,
      solvedPuzzleIds: {}, // { [puzzleId]: true }
    };
  }

  function clampProgress() {
    const p = globalThis.__mindlabProgress;

    if (typeof p.total !== "number") p.total = 3;
    if (typeof p.solved !== "number") p.solved = 0;

    if (p.total < 0) p.total = 0;
    if (p.solved < 0) p.solved = 0;
    if (p.solved > p.total) p.solved = p.total;

    if (typeof p.solvedToday !== "number") p.solvedToday = 0;
    if (typeof p.totalSolved !== "number") p.totalSolved = 0;
    if (typeof p.streak !== "number") p.streak = 0;

    if (!p.solvedPuzzleIds || typeof p.solvedPuzzleIds !== "object") {
      p.solvedPuzzleIds = {};
    }
  }

  function getSolvedIds(p) {
    return Object.keys(p.solvedPuzzleIds || {});
  }

  function doSolve(req, res) {
    try {
      clampProgress();
      const p = globalThis.__mindlabProgress;

      const body = req.body || {};
      const puzzleId = body.puzzleId || body.id || body.puzzle || null;

      if (puzzleId && !p.solvedPuzzleIds[puzzleId]) {
        p.solvedPuzzleIds[puzzleId] = true;
        p.solved = Math.min(p.total, p.solved + 1);
        p.solvedToday += 1;
        p.totalSolved += 1;
      } else if (!puzzleId) {
        p.solved = Math.min(p.total, p.solved + 1);
        p.solvedToday += 1;
        p.totalSolved += 1;
      }

      clampProgress();

      return res.status(200).json({
        ok: true,
        puzzleId: puzzleId,
        progress: {
          total: p.total,
          solved: p.solved,
          solvedToday: p.solvedToday,
          totalSolved: p.totalSolved,
          streak: p.streak,
          solvedIds: getSolvedIds(p),
        },
      });
    } catch (e) {
      return res.status(500).json({ ok: false, error: String(e) });
    }
  }

  // GET /progress -- now includes solvedIds
  app.get("/progress", (_req, res) => {
    clampProgress();
    const p = globalThis.__mindlabProgress;
    return res.json({
      total: p.total,
      solved: p.solved,
      solvedIds: getSolvedIds(p),
    });
  });

  // POST /progress/solve
  app.post("/progress/solve", (req, res) => doSolve(req, res));

  // Legacy POST /progress
  app.post("/progress", (req, res) => {
    clampProgress();
    const p = globalThis.__mindlabProgress;

    const body = req.body || {};
    if (body.correct === true) {
      p.solved = Math.min(p.total, p.solved + 1);
    }

    clampProgress();
    return res.json({
      total: p.total,
      solved: p.solved,
      solvedIds: getSolvedIds(p),
    });
  });

  // Reset (testing)
  app.post("/progress/reset", (_req, res) => {
    const p = globalThis.__mindlabProgress;
    p.solved = 0;
    p.solvedToday = 0;
    p.totalSolved = 0;
    p.streak = 0;
    p.solvedPuzzleIds = {};
    clampProgress();
    return res.json({ ok: true, total: p.total, solved: p.solved, solvedIds: [] });
  });
};
